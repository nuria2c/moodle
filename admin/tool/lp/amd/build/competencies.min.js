define(["jquery","core/notification","core/ajax","core/templates","tool_lp/dialogue","core/str","tool_lp/tree","tool_lp/dragdrop-reorder"],function(a,b,c,d,e,f,g,h){var i=function(e,f,g){this.itemid=e,this.itemtype=f,this.pageContextId=g,this.selectedCompetency=0;var h=this,i=c.call([{methodname:"tool_lp_list_competency_frameworks",args:{sort:"shortname",context:{contextid:this.pageContextId},includes:"parents"}}]);i[0].done(function(c){return h.frameworks=c,0===c.length?void d.render("tool_lp/no_frameworks_warning",{}).done(function(b){a('[data-region="actions"]').append(b),a('[data-region="actions"] button').hide()}).fail(b.exception):(a('[data-region="actions"] button').show(),h.registerEvents(),void h.registerDragDrop())}).fail(b.exception)};return i.prototype.registerDragDrop=function(){var a=this;f.get_string("movecompetency","tool_lp").done(function(b){h.dragdrop("movecompetency",b,{identifier:"movecompetency",component:"tool_lp"},{identifier:"movecompetencyafter",component:"tool_lp"},"drag-samenode","drag-parentnode","drag-handlecontainer",function(b,c){a.handleDrop.call(a,b,c)})}).fail(b.exception)},i.prototype.handleDrop=function(d,e){var f=a(d).data("id"),g=a(e).data("id"),h=this,i=[];if("course"==h.itemtype)i=c.call([{methodname:"tool_lp_reorder_course_competency",args:{courseid:h.itemid,competencyidfrom:f,competencyidto:g}}]);else{if("template"!=h.itemtype)return null;i=c.call([{methodname:"tool_lp_reorder_template_competency",args:{templateid:h.itemid,competencyidfrom:f,competencyidto:g}}])}i[0].fail(b.exception)},i.prototype.applyFilter=function(c){c.preventDefault();var e=this,f=a('[data-region="filtercompetencies"] input'),g=f.val(),h=a('[data-action="chooseframework"]'),i=h.val();this.searchCompetencies().done(function(c){var f=0,h=e.frameworks[0];for(f=0;f<e.frameworks.length;f++)e.frameworks[f].id==i?(h=e.frameworks[f],h.selected=!0):e.frameworks[f].selected=!1;h.selected=!0;var j={framework:h,frameworks:e.frameworks,competencies:c,search:g};d.render("tool_lp/link_competencies",j).done(function(b){a('[data-region="competencylinktree"]').replaceWith(b),e.initLinkCompetencies()}).fail(b.exception)}).fail(b.exception)},i.prototype.initLinkCompetencies=function(){var e=this;new g("[data-enhance=linktree]",function(a){e.selectedCompetency=a.data("id")}),a('[data-action="chooseframework"]').change(function(a){return e.applyFilter.call(e,a)}),a('[data-region="filtercompetencies"] button').click(function(b){return a(b.target).attr("disabled","disabled"),e.applyFilter.call(e,b)}),a('[data-region="competencylinktree"] [data-action="cancel"]').click(function(b){a(b.target).attr("disabled","disabled"),b.preventDefault(),e.popup.close()}),a('[data-region="competencylinktree"] [data-action="add"]').click(function(f){var g=[],h="",i="";if(f.preventDefault(),e.selectedCompetency){if(a(f.target).attr("disabled","disabled"),"course"==e.itemtype)g=c.call([{methodname:"tool_lp_add_competency_to_course",args:{courseid:e.itemid,competencyid:e.selectedCompetency}},{methodname:"tool_lp_data_for_course_competencies_page",args:{courseid:e.itemid}}]),h="tool_lp/course_competencies_page",i="coursecompetenciespage";else{if("template"!=e.itemtype)return null;g=c.call([{methodname:"tool_lp_add_competency_to_template",args:{templateid:e.itemid,competencyid:e.selectedCompetency}},{methodname:"tool_lp_data_for_template_competencies_page",args:{templateid:e.itemid,pagecontext:{contextid:e.pageContextId}}}]),h="tool_lp/template_competencies_page",i="templatecompetenciespage"}g[1].done(function(c){d.render(h,c).done(function(b,c){e.popup.close(),a('[data-region="'+i+'"]').replaceWith(b),d.runTemplateJS(c)}).fail(b.exception)}).fail(b.exception)}})},i.prototype.registerEvents=function(){var e=this;a('[data-region="actions"] button').click(function(a){return e.openCompetencySelector.call(e,a)}),a('[data-action="delete-competency-link"]').click(function(f){var g=[],h="",i="";f.preventDefault();var j=a(f.target).closest("[data-id]").data("id");"course"==e.itemtype?(g=c.call([{methodname:"tool_lp_remove_competency_from_course",args:{courseid:e.itemid,competencyid:j}},{methodname:"tool_lp_data_for_course_competencies_page",args:{courseid:e.itemid}}]),h="tool_lp/course_competencies_page",i="coursecompetenciespage"):"template"==e.itemtype&&(g=c.call([{methodname:"tool_lp_remove_competency_from_template",args:{templateid:e.itemid,competencyid:j}},{methodname:"tool_lp_data_for_template_competencies_page",args:{templateid:e.itemid,pagecontext:{contextid:e.pageContextId}}}]),h="tool_lp/template_competencies_page",i="templatecompetenciespage"),g[1].done(function(c){d.render(h,c).done(function(b,c){a('[data-region="'+i+'"]').replaceWith(b),d.runTemplateJS(c)}).fail(b.exception)}).fail(b.exception)})},i.prototype.addCompetencyChildren=function(a,b){var c;for(c=0;c<b.length;c++)b[c].parentid==a.id&&(a.haschildren=!0,b[c].children=[],b[c].haschildren=!1,a.children[a.children.length]=b[c],this.addCompetencyChildren(b[c],b))},i.prototype.searchCompetencies=function(){var b=this,d=a.Deferred(),e=a('[data-region="filtercompetencies"] input'),f="";e.length&&(f=e.val());var g=a('[data-action="chooseframework"]'),h=b.frameworks[0].id;g.length&&(h=g.val());var i=c.call([{methodname:"tool_lp_search_competencies",args:{searchtext:f,competencyframeworkid:h}}]);return i[0].done(function(a){var c,e=[];for(c=0;c<a.length;c++){var f=a[c];"0"===f.parentid&&(f.children=[],f.haschildren=0,e[e.length]=f,b.addCompetencyChildren(f,a))}d.resolve(e)}).fail(function(a){d.reject(a)}),d.promise()},i.prototype.openCompetencySelector=function(a){a.preventDefault();var c=this;this.searchCompetencies().done(function(a){var g=c.frameworks[0];g.selected=!0;var h={framework:g,frameworks:c.frameworks,competencies:a,search:""};d.render("tool_lp/link_competencies",h).done(function(a){f.get_string("linkcompetencies","tool_lp").done(function(b){c.popup=new e(b,a,function(){c.initLinkCompetencies.call(c)})}).fail(b.exception)}).fail(b.exception)}).fail(b.exception)},i});