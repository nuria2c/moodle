define(["jquery","core/templates","core/ajax","core/notification","core/str","tool_lp/menubar"],function(a,b,c,d,e,f){var g=function(a){if(this._type=a,"plan"===a)this._region='[data-region="plan-page"]',this._planNode='[data-region="plan-page"]',this._template="tool_lp/plan_page",this._contextMethod="tool_lp_data_for_plan_page";else{if("plans"!==a)throw new TypeError("Unexpected type.");this._region='[data-region="plans"]',this._planNode='[data-region="plan-node"]',this._template="tool_lp/plans_page",this._contextMethod="tool_lp_data_for_plans_page"}};return g.prototype._contextMethod=null,g.prototype._planNode=null,g.prototype._region=null,g.prototype._template=null,g.prototype._type=null,g.prototype._getContextArgs=function(a){var b=this,c={};return"plan"===b._type?c={planid:a.id}:"plans"===b._type&&(c={userid:a.userid}),c},g.prototype._renderView=function(c){var e=this;b.render(e._template,c).done(function(c,d){a(e._region).replaceWith(c),b.runTemplateJS(d)}.bind(e)).fail(d.exception)},g.prototype._callAndRefresh=function(b,e){var f=this;return b.push({methodname:f._contextMethod,args:f._getContextArgs(e)}),a.when.apply(a.when,c.call(b)).then(function(){f._renderView.call(f,arguments[arguments.length-1])}).fail(d.exception)},g.prototype._doDelete=function(a){var b=this,c=[{methodname:"tool_lp_delete_plan",args:{id:a.id}}];b._callAndRefresh(c,a)},g.prototype.deletePlan=function(a){var b,f=this;b=c.call([{methodname:"tool_lp_read_plan",args:{id:a.id}}]),b[0].done(function(b){e.get_strings([{key:"confirm",component:"moodle"},{key:"deleteplan",component:"tool_lp",param:b.name},{key:"delete",component:"moodle"},{key:"cancel",component:"moodle"}]).done(function(b){d.confirm(b[0],b[1],b[2],b[3],function(){f._doDelete(a)}.bind(f))}).fail(d.exception)}).fail(d.exception)},g.prototype._deletePlanHandler=function(b){b.preventDefault();var c=this._findPlanData(a(b.target));this.deletePlan(c)},g.prototype._doReopenPlan=function(a){var b=this,c=[{methodname:"tool_lp_reopen_plan",args:{planid:a.id}}];b._callAndRefresh(c,a)},g.prototype.reopenPlan=function(a){var b=this,f=c.call([{methodname:"tool_lp_read_plan",args:{id:a.id}}]);f[0].done(function(c){e.get_strings([{key:"confirm",component:"moodle"},{key:"reopenplanconfirm",component:"tool_lp",param:c.name},{key:"reopenplan",component:"tool_lp"},{key:"cancel",component:"moodle"}]).done(function(c){d.confirm(c[0],c[1],c[2],c[3],function(){b._doReopenPlan(a)}.bind(b))}).fail(d.exception)}).fail(d.exception)},g.prototype._reopenPlanHandler=function(b){b.preventDefault();var c=this._findPlanData(a(b.target));this.reopenPlan(c)},g.prototype._doCompletePlan=function(a){var b=this,c=[{methodname:"tool_lp_complete_plan",args:{planid:a.id}}];b._callAndRefresh(c,a)},g.prototype.completePlan=function(a){var b=this,f=c.call([{methodname:"tool_lp_read_plan",args:{id:a.id}}]);f[0].done(function(c){e.get_strings([{key:"confirm",component:"moodle"},{key:"completeplanconfirm",component:"tool_lp",param:c.name},{key:"completeplan",component:"tool_lp"},{key:"cancel",component:"moodle"}]).done(function(c){d.confirm(c[0],c[1],c[2],c[3],function(){b._doCompletePlan(a)}.bind(b))}).fail(d.exception)}).fail(d.exception)},g.prototype._completePlanHandler=function(b){b.preventDefault();var c=this._findPlanData(a(b.target));this.completePlan(c)},g.prototype._doUnlinkPlan=function(a){var b=this,c=[{methodname:"tool_lp_unlink_plan_from_template",args:{planid:a.id}}];b._callAndRefresh(c,a)},g.prototype.unlinkPlan=function(a){var b=this,f=c.call([{methodname:"tool_lp_read_plan",args:{id:a.id}}]);f[0].done(function(c){e.get_strings([{key:"confirm",component:"moodle"},{key:"unlinkplantemplateconfirm",component:"tool_lp",param:c.name},{key:"unlinkplantemplate",component:"tool_lp"},{key:"cancel",component:"moodle"}]).done(function(c){d.confirm(c[0],c[1],c[2],c[3],function(){b._doUnlinkPlan(a)}.bind(b))}).fail(d.exception)}).fail(d.exception)},g.prototype._unlinkPlanHandler=function(b){b.preventDefault();var c=this._findPlanData(a(b.target));this.unlinkPlan(c)},g.prototype._findPlanData=function(b){var c,d=b.parentsUntil(a(this._region).parent(),this._planNode);if(1!=d.length)throw new Error("The plan node was not located.");if(c=d.data(),"undefined"==typeof c||"undefined"==typeof c.id)throw new Error("Plan data could not be found.");return c},g.prototype.enhanceMenubar=function(a){var b=this;f.enhance(a,{'[data-action="plan-delete"]':b._deletePlanHandler.bind(b),'[data-action="plan-complete"]':b._completePlanHandler.bind(b),'[data-action="plan-reopen"]':b._reopenPlanHandler.bind(b),'[data-action="plan-unlink"]':b._unlinkPlanHandler.bind(b)})},g.prototype.registerEvents=function(){var b=a(this._region),c=this;b.find('[data-action="plan-delete"]').click(c._deletePlanHandler.bind(c)),b.find('[data-action="plan-complete"]').click(c._completePlanHandler.bind(c)),b.find('[data-action="plan-reopen"]').click(c._reopenPlanHandler.bind(c)),b.find('[data-action="plan-unlink"]').click(c._unlinkPlanHandler.bind(c))},g});